{% extends "base.html" %}

{%block sub-title%}Tests | {% endblock %}

{% block style%}
#canvas { border: solid 1px #eee; margin-top: 10px; }
{% endblock %}

{% block sub-head %}
<script type="text/javascript" src="{{MEDIA_URL}}glge/glge_math.js"></script> 
<script type="text/javascript" src="{{MEDIA_URL}}glge/glge.js"></script> 
<script type="text/javascript" src="{{MEDIA_URL}}glge/glge_input.js"></script> 
<script src="{% url sim.views.spaciblo_js %}"></script>

<link rel="stylesheet" href="{{ MEDIA_URL }}qunit/qunit.css" type="text/css" media="screen" />
<script type="text/javascript" src="{{ MEDIA_URL }}qunit/qunit.js"></script>
{% endblock %}

{% block script %}

function runTests(){
   module("Renderer");
   
   test("initialization tests", function(){
      var sceneDoc = '{"thing": {"attributes": {"position": "0.0,0.0,0.0", "scale": 1.0, "id": 0, "orientation": "1.0,0.0,0.0,0.0"}, "type": "Thing", "children": [{"attributes": {"position": "0.0,0.0,0.0", "scale": 1.0, "id": 1, "template": 6, "orientation": "1.0,0.0,0.0,0.0"}, "type": "Thing"}, {"attributes": {"position": "0.0,40.0,0.0", "scale": 1.0, "id": 2, "template": 3, "orientation": "1.0,0.0,0.0,0.0"}, "type": "Thing"}]}, "type": "Scene", "attributes": {"background_color": "0.2,0.5,0.8,1.0"}}';
      var scene = SpacibloScene.parseSceneDocument(sceneDoc);
      var canvas = new SpacibloRenderer.Canvas('canvas');
      ok(canvas.initialize(scene, 'trevor'), "Could not initialize the canvas.");
      canvas.render();
   });
   
   module("Events");
   
   test("serialization tests", function(){
      var event = new SpacibloEvents.JoinSpaceRequest(32);
      var event_json = event.toJSON()
      var event_json_data = JSON.parse(event_json)
      var parsed_event = SpacibloEvents.rehydrateEvent(event_json_data);
      equals(event.space_id, parsed_event.space_id, 'Event space ids are not equal');

      event = new SpacibloEvents.AuthenticationResponse('someone');
      event_json = event.toJSON()
      event_json_data = JSON.parse(event_json)
      parsed_event = SpacibloEvents.rehydrateEvent(event_json_data);
      equals(event.username, parsed_event.username, 'Event username are not equal');
      
      var color = new SpacibloScene.Color("1,0.5,0.1");
      equals(color.red, 1);
      equals(color.green, 0.5);
      equals(color.blue, 0.1);
   });
   
   module("Asset Manager");
   
   test("load valid geometry", function(){
      var assetManager = new SpacibloRenderer.AssetManager(
         function(image, path){ },
         function(template){ },
         function(templateID, templateAssetID, geometry){
            ok(templateID == 2, "Incorrect template id: " + templateID);
            ok(templateAssetID, "No templateAssetID");
            ok(geometry, "No Geometry");
			console.log(geometry);
            ok(geometry.children.length == 0, "Cube should have no children");
            ok(geometry.vertices.length == 54, "Cube should have 54 vertices: " + geometry.vertices.length);
            start();
         }
      );
      assetManager.getOrCreateTemplate(2);
      stop();
   });

   test("load bigger geometry", function(){
      var assetManager = new SpacibloRenderer.AssetManager(
         function(image, path){ },
         function(template){ },
         function(templateID, templateAssetID, geometry){
            ok(templateID == 3, "Incorrect image id: " + templateID);
            ok(templateAssetID, "No templateAssetID");
            ok(geometry, "No Geometry");
            ok(geometry.vertices.length == 0);
            ok(geometry.children.length == 40, "Glass house should have 40 children.");
            ok(geometry.children[0].material.name == "GreatroomBase", "The first material should have the name GreatroomBase: " + geometry.children[0].material.name);
            ok(geometry.children[0].material.phong_specular == 96.078431, "The first material should have a phong specular of 96.078431: " + geometry.children[0].material.phong_specular);
            start();
         }
      );
      assetManager.getOrCreateTemplate(3);
      stop();
   });

   test("load beanie geometry", function(){
      var assetManager = new SpacibloRenderer.AssetManager(
         function(image, path){ },
         function(template){ },
         function(templateID, templateAssetID, geometry){
            ok(templateID == 1, "Incorrect image id: " + templateID);
            ok(templateAssetID, "No templateAssetID");
            ok(geometry, "No Geometry");
            ok(geometry.vertices.length == 828, "The geometry should have 828 vertices: " + geometry.vertices.length);
            ok(geometry.uvs.length == 550, "The geometry should have 550 uvs: " + geometry.uvs.length);
            ok(geometry.normals.length == 825, "The geometry should have 825 normals: " + geometry.normals.length);
            start();
         }
      );
      assetManager.getOrCreateTemplate(1);
      stop();
   });

   test("load valid image", function(){
      var testImagePath = "/media/spaciblo/Spaciblo-Logo.jpg"
      var assetManager = new SpacibloRenderer.AssetManager(function(image, path){
            ok(image != null, "A valid image could not be loaded");
            ok(path == testImagePath, "The image path was not valid: " + path);
            ok(image == assetManager.getImage(testImagePath), "Could not get the already loaded image.");
            ok(assetManager.images[path].image = image, "assetManager images had incorrect path");
            start();
         }, function(template){}, function(templateID, templateAssetID, geometry){}
      );
      assetManager.loadImage(testImagePath);
      stop();
   });

   test("load invalid image", function(){
      var testImagePath = "/media/DoesNotExist.jpg"
      var assetManager = new SpacibloRenderer.AssetManager(function(image, path){
         ok(image == null, "A invalid image should be null");
         ok(path == testImagePath, "The image path was not valid: " + path);
         ok(assetManager.getImage(testImagePath) == null, "Received non-null for invalid get_image: " + assetManager.getImage(testImagePath));
         start();
      }, function(template){}, function(templateID, templateAssetID, geometry){});
      assetManager.loadImage(testImagePath);
      stop();
   });
   
   test("load template", function(){
      // right now the asset manager just creates them on demand, so let's test that
      var assetManager = new SpacibloRenderer.AssetManager(function(image, path){}, function(template){}, function(templateID, templateAssetID, geometry){});
      var template1 = assetManager.getTemplate(1);
      ok(template1 == null, "Should not have a template at this point");
      template1 = assetManager.getOrCreateTemplate(1);
      ok(template1 != null, "Should have created a template.");
      ok(template1 == assetManager.getOrCreateTemplate(1), "Should have returned the previously created template");
   });
}

$(document).ready(runTests);

{% endblock %}

{% block content%}
<h1 id="qunit-header">QUnit example</h1>
<h2 id="qunit-banner"></h2>
<h2 id="qunit-userAgent"></h2>
<ol id="qunit-tests"></ol>
<canvas id="canvas" width="400" height="150"></canvas>

{% endblock %}
